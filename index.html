<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>日文自學系統 | Japanese Learning</title>
    
    <!-- 1. 載入 React 核心 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 2. 載入 Babel (解析 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. 載入 Tailwind CSS (樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-red': '#b91c1c',     /* 茜色 */
                        'jp-indigo': '#1e3a8a',  /* 藍染 */
                        'jp-cream': '#fcfaf2',   /* 和紙 */
                        'jp-dark': '#2c2c2c',    /* 墨色 */
                        'jp-pink': '#fbcfe8',    /* 櫻色 */
                    },
                    fontFamily: {
                        'serif': ['Noto Serif JP', 'Noto Serif TC', 'serif'],
                        'sans': ['Noto Sans JP', 'Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- 4. 載入 Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+JP:wght@600;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif;
            background-color: #fcfaf2;
            color: #2c2c2c;
            -webkit-font-smoothing: antialiased;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .font-jp-serif { font-family: 'Noto Serif JP', serif; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #fcfaf2; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
        
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slideIn { animation: slideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }

        @keyframes float { 0% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-10px) rotate(5deg); } 100% { transform: translateY(0px) rotate(0deg); } }
        .animate-float { animation: float 6s ease-in-out infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- 內建 SVG Icons ---
        const Icon = ({ path, className = "", size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d={path} />
            </svg>
        );

        const ICONS = {
            Book: "M4 19.5A2.5 2.5 0 0 1 6.5 17H20M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z",
            ChevronLeft: "M15 18l-6-6 6-6",
            ChevronRight: "M9 18l6-6-6-6",
            Trash2: "M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6",
            Download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3",
            Upload: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12",
            Plus: "M12 5v14M5 12h14",
            RotateCcw: "M1 4v6h6M3.51 15a9 9 0 1 0 2.13-9.36L1 10",
            CheckCircle: "M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4L12 14.01l-3-3",
            XCircle: "M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 1 1-18 0 9 9 0 0 1 18 0z",
            Search: "M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16z M21 21l-4.35-4.35",
            Cloud: "M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z",
            Loader2: "M21 12a9 9 0 1 1-6.219-8.56", 
            WifiOff: "M1 1l22 22 M16.72 11.06A10.94 10.94 0 0 1 19 12.55 M5 12.55a10.94 10.94 0 0 1 5.17-2.39 M10.71 5.05A16 16 0 0 1 22.58 9 M1.42 9a15.91 15.91 0 0 1 4.7-2.88 M8.53 16.11a6 6 0 0 1 6.95 0 M12 20h.01",
            Home: "M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",
            Flower: "M12 7.5a4.5 4.5 0 1 1 4.5 4.5M12 7.5A4.5 4.5 0 1 0 7.5 12M12 7.5V9m0 0v1.5m0-1.5h1.5m-1.5 0H10.5m-3 7.5a4.5 4.5 0 1 0 4.5 4.5M7.5 16.5A4.5 4.5 0 1 1 12 12m-4.5 4.5H9m0 0h1.5m-1.5 0v1.5m0-1.5V15",
            Settings: "M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2zM12 9a3 3 0 1 1 0 6 3 3 0 0 1 0-6z",
            RefreshCw: "M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8 M3 3v5h5 M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16 M21 21v-5h-5"
        };

        const LucideIcon = ({ name, ...props }) => {
            const path = ICONS[name];
            if (!path) return null;
            return <Icon path={path} {...props} />;
        };

        // --- Firebase 設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyCBOmSZTrEqti7TnCFaSfZlXCmjVqY7mn8",
            authDomain: "japanese-2faca.firebaseapp.com",
            projectId: "japanese-2faca",
            storageBucket: "japanese-2faca.firebasestorage.app",
            messagingSenderId: "423393532516",
            appId: "1:423393532516:web:1bdd2baf986b377542dd71",
            measurementId: "G-NVRF6XDB83"
        };

        if (window.firebase && !window.firebase.apps.length) {
            try { window.firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
        }

        // --- 資料 ---
        const INITIAL_KANA = [
            { char: 'あ', romaji: 'a', type: 'hira', group: '清音' }, { char: 'い', romaji: 'i', type: 'hira', group: '清音' }, { char: 'う', romaji: 'u', type: 'hira', group: '清音' }, { char: 'え', romaji: 'e', type: 'hira', group: '清音' }, { char: 'お', romaji: 'o', type: 'hira', group: '清音' },
            { char: 'か', romaji: 'ka', type: 'hira', group: '清音' }, { char: 'き', romaji: 'ki', type: 'hira', group: '清音' }, { char: 'く', romaji: 'ku', type: 'hira', group: '清音' }, { char: 'け', romaji: 'ke', type: 'hira', group: '清音' }, { char: 'こ', romaji: 'ko', type: 'hira', group: '清音' },
            { char: 'さ', romaji: 'sa', type: 'hira', group: '清音' }, { char: 'し', romaji: 'shi', type: 'hira', group: '清音' }, { char: 'す', romaji: 'su', type: 'hira', group: '清音' }, { char: 'せ', romaji: 'se', type: 'hira', group: '清音' }, { char: 'そ', romaji: 'so', type: 'hira', group: '清音' },
            { char: 'た', romaji: 'ta', type: 'hira', group: '清音' }, { char: 'ち', romaji: 'chi', type: 'hira', group: '清音' }, { char: 'つ', romaji: 'tsu', type: 'hira', group: '清音' }, { char: 'て', romaji: 'te', type: 'hira', group: '清音' }, { char: 'と', romaji: 'to', type: 'hira', group: '清音' },
            { char: 'な', romaji: 'na', type: 'hira', group: '清音' }, { char: 'に', romaji: 'ni', type: 'hira', group: '清音' }, { char: 'ぬ', romaji: 'nu', type: 'hira', group: '清音' }, { char: 'ね', romaji: 'ne', type: 'hira', group: '清音' }, { char: 'の', romaji: 'no', type: 'hira', group: '清音' },
            { char: 'は', romaji: 'ha', type: 'hira', group: '清音' }, { char: 'ひ', romaji: 'hi', type: 'hira', group: '清音' }, { char: 'ふ', romaji: 'fu', type: 'hira', group: '清音' }, { char: 'へ', romaji: 'he', type: 'hira', group: '清音' }, { char: 'ほ', romaji: 'ho', type: 'hira', group: '清音' },
            { char: 'ま', romaji: 'ma', type: 'hira', group: '清音' }, { char: 'み', romaji: 'mi', type: 'hira', group: '清音' }, { char: 'む', romaji: 'mu', type: 'hira', group: '清音' }, { char: 'め', romaji: 'me', type: 'hira', group: '清音' }, { char: 'も', romaji: 'mo', type: 'hira', group: '清音' },
            { char: 'や', romaji: 'ya', type: 'hira', group: '清音' }, { char: '', romaji: '', type: 'hira', group: '清音' }, { char: 'ゆ', romaji: 'yu', type: 'hira', group: '清音' }, { char: '', romaji: '', type: 'hira', group: '清音' }, { char: 'よ', romaji: 'yo', type: 'hira', group: '清音' },
            { char: 'ら', romaji: 'ra', type: 'hira', group: '清音' }, { char: 'り', romaji: 'ri', type: 'hira', group: '清音' }, { char: 'る', romaji: 'ru', type: 'hira', group: '清音' }, { char: 'れ', romaji: 're', type: 'hira', group: '清音' }, { char: 'ろ', romaji: 'ro', type: 'hira', group: '清音' },
            { char: 'わ', romaji: 'wa', type: 'hira', group: '清音' }, { char: '', romaji: '', type: 'hira', group: '清音' }, { char: 'を', romaji: 'wo', type: 'hira', group: '清音' }, { char: '', romaji: '', type: 'hira', group: '清音' }, { char: 'ん', romaji: 'n', type: 'hira', group: '清音' },
            { char: 'ア', romaji: 'a', type: 'kata', group: '清音' }, { char: 'イ', romaji: 'i', type: 'kata', group: '清音' }, { char: 'ウ', romaji: 'u', type: 'kata', group: '清音' }, { char: 'エ', romaji: 'e', type: 'kata', group: '清音' }, { char: 'オ', romaji: 'o', type: 'kata', group: '清音' },
            { char: 'カ', romaji: 'ka', type: 'kata', group: '清音' }, { char: 'キ', romaji: 'ki', type: 'kata', group: '清音' }, { char: 'ク', romaji: 'ku', type: 'kata', group: '清音' }, { char: 'ケ', romaji: 'ke', type: 'kata', group: '清音' }, { char: 'コ', romaji: 'ko', type: 'kata', group: '清音' },
            { char: 'サ', romaji: 'sa', type: 'kata', group: '清音' }, { char: 'シ', romaji: 'shi', type: 'kata', group: '清音' }, { char: 'ス', romaji: 'su', type: 'kata', group: '清音' }, { char: 'セ', romaji: 'se', type: 'kata', group: '清音' }, { char: 'ソ', romaji: 'so', type: 'kata', group: '清音' },
            { char: 'タ', romaji: 'ta', type: 'kata', group: '清音' }, { char: 'チ', romaji: 'chi', type: 'kata', group: '清音' }, { char: 'ツ', romaji: 'tsu', type: 'kata', group: '清音' }, { char: 'テ', romaji: 'te', type: 'kata', group: '清音' }, { char: 'ト', romaji: 'to', type: 'kata', group: '清音' },
            { char: 'ナ', romaji: 'na', type: 'kata', group: '清音' }, { char: 'ニ', romaji: 'ni', type: 'kata', group: '清音' }, { char: 'ヌ', romaji: 'nu', type: 'kata', group: '清音' }, { char: 'ネ', romaji: 'ne', type: 'kata', group: '清音' }, { char: 'ノ', romaji: 'no', type: 'kata', group: '清音' },
            { char: 'ハ', romaji: 'ha', type: 'kata', group: '清音' }, { char: 'ヒ', romaji: 'hi', type: 'kata', group: '清音' }, { char: 'フ', romaji: 'fu', type: 'kata', group: '清音' }, { char: 'ヘ', romaji: 'he', type: 'kata', group: '清音' }, { char: 'ホ', romaji: 'ho', type: 'kata', group: '清音' },
            { char: 'マ', romaji: 'ma', type: 'kata', group: '清音' }, { char: 'ミ', romaji: 'mi', type: 'kata', group: '清音' }, { char: 'ム', romaji: 'mu', type: 'kata', group: '清音' }, { char: 'メ', romaji: 'me', type: 'kata', group: '清音' }, { char: 'モ', romaji: 'mo', type: 'kata', group: '清音' },
            { char: 'ヤ', romaji: 'ya', type: 'kata', group: '清音' }, { char: '', romaji: '', type: 'kata', group: '清音' }, { char: 'ユ', romaji: 'yu', type: 'kata', group: '清音' }, { char: '', romaji: '', type: 'kata', group: '清音' }, { char: 'ヨ', romaji: 'yo', type: 'kata', group: '清音' },
            { char: 'ラ', romaji: 'ra', type: 'kata', group: '清音' }, { char: 'リ', romaji: 'ri', type: 'kata', group: '清音' }, { char: 'ル', romaji: 'ru', type: 'kata', group: '清音' }, { char: 'レ', romaji: 're', type: 'kata', group: '清音' }, { char: 'ロ', romaji: 'ro', type: 'kata', group: '清音' },
            { char: 'ワ', romaji: 'wa', type: 'kata', group: '清音' }, { char: '', romaji: '', type: 'kata', group: '清音' }, { char: 'ヲ', romaji: 'wo', type: 'kata', group: '清音' }, { char: '', romaji: '', type: 'kata', group: '清音' }, { char: 'ン', romaji: 'n', type: 'kata', group: '清音' },

            { char: 'が', romaji: 'ga', type: 'hira', group: '濁音' }, { char: 'ぎ', romaji: 'gi', type: 'hira', group: '濁音' }, { char: 'ぐ', romaji: 'gu', type: 'hira', group: '濁音' }, { char: 'げ', romaji: 'ge', type: 'hira', group: '濁音' }, { char: 'ご', romaji: 'go', type: 'hira', group: '濁音' },
            { char: 'ざ', romaji: 'za', type: 'hira', group: '濁音' }, { char: 'じ', romaji: 'ji', type: 'hira', group: '濁音' }, { char: 'ず', romaji: 'zu', type: 'hira', group: '濁音' }, { char: 'ぜ', romaji: 'ze', type: 'hira', group: '濁音' }, { char: 'ぞ', romaji: 'zo', type: 'hira', group: '濁音' },
            { char: 'だ', romaji: 'da', type: 'hira', group: '濁音' }, { char: 'ぢ', romaji: 'ji', type: 'hira', group: '濁音' }, { char: 'づ', romaji: 'zu', type: 'hira', group: '濁音' }, { char: 'で', romaji: 'de', type: 'hira', group: '濁音' }, { char: 'ど', romaji: 'do', type: 'hira', group: '濁音' },
            { char: 'ば', romaji: 'ba', type: 'hira', group: '濁音' }, { char: 'び', romaji: 'bi', type: 'hira', group: '濁音' }, { char: 'ぶ', romaji: 'bu', type: 'hira', group: '濁音' }, { char: 'べ', romaji: 'be', type: 'hira', group: '濁音' }, { char: 'ぼ', romaji: 'bo', type: 'hira', group: '濁音' },
            { char: 'ぱ', romaji: 'pa', type: 'hira', group: '半濁音' }, { char: 'ぴ', romaji: 'pi', type: 'hira', group: '半濁音' }, { char: 'ぷ', romaji: 'pu', type: 'hira', group: '半濁音' }, { char: 'ぺ', romaji: 'pe', type: 'hira', group: '半濁音' }, { char: 'ぽ', romaji: 'po', type: 'hira', group: '半濁音' },
            { char: 'きゃ', romaji: 'kya', type: 'hira', group: '拗音' }, { char: 'きゅ', romaji: 'kyu', type: 'hira', group: '拗音' }, { char: 'きょ', romaji: 'kyo', type: 'hira', group: '拗音' },
            { char: 'しゃ', romaji: 'sha', type: 'hira', group: '拗音' }, { char: 'しゅ', romaji: 'shu', type: 'hira', group: '拗音' }, { char: 'しょ', romaji: 'sho', type: 'hira', group: '拗音' },
            { char: 'ちゃ', romaji: 'cha', type: 'hira', group: '拗音' }, { char: 'ちゅ', romaji: 'chu', type: 'hira', group: '拗音' }, { char: 'ちょ', romaji: 'cho', type: 'hira', group: '拗音' },
        ];

        const KANA_QUIZ_POOL = INITIAL_KANA.filter(k => k.char !== '');

        // --- 元件: Button ---
        const Button = React.forwardRef(({ children, onClick, className = "", variant = "primary", disabled = false, autoFocus, title }, ref) => {
            const baseStyle = "px-4 py-2 md:px-6 md:py-3 rounded-lg font-bold transition-all duration-300 transform active:scale-95 flex items-center justify-center gap-2 outline-none select-none tracking-wide";
            const variants = {
                primary: "bg-jp-indigo text-white hover:bg-indigo-900 shadow-md hover:shadow-lg border border-transparent",
                secondary: "bg-white text-jp-indigo border-2 border-jp-indigo hover:bg-indigo-50",
                danger: "bg-white text-jp-red border-2 border-jp-red hover:bg-red-50",
                success: "bg-emerald-600 text-white hover:bg-emerald-700 shadow-md",
                ghost: "bg-transparent text-gray-500 hover:text-jp-indigo shadow-none px-2",
                light: "bg-gray-100 text-gray-600 hover:bg-gray-200 border border-gray-200"
            };
            return (
                <button ref={ref} onClick={onClick} disabled={disabled} autoFocus={autoFocus} title={title} className={`${baseStyle} ${variants[variant]} ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}>
                    {children}
                </button>
            );
        });

        // --- 頁面: 五十音練習 ---
        const KanaTablePage = ({ onBack }) => {
            const [activeTab, setActiveTab] = useState('hira');
            const renderGrid = (type) => (
                <div className="grid grid-cols-5 gap-2 md:gap-4 mb-6">
                    {INITIAL_KANA.filter(k => k.type === type && k.group === '清音').slice(0, 46).map((k, idx) => (
                        <div key={idx} className={`aspect-square flex flex-col items-center justify-center rounded-lg border ${k.char ? 'bg-white border-stone-200 hover:border-jp-indigo hover:shadow-md cursor-pointer' : 'border-transparent'} transition-all duration-300`}>
                            {k.char && <><span className="text-2xl md:text-3xl font-jp-serif text-jp-dark">{k.char}</span><span className="text-xs md:text-sm text-gray-400 font-mono mt-1">{k.romaji}</span></>}
                        </div>
                    ))}
                </div>
            );
            return (
                <div className="max-w-4xl mx-auto p-4 animate-slideIn">
                    <div className="flex items-center mb-6"><Button variant="ghost" onClick={onBack}><LucideIcon name="ChevronLeft" /> 返回</Button><h2 className="text-2xl font-bold ml-2 text-jp-dark font-jp-serif">五十音練習</h2></div>
                    <div className="flex gap-4 mb-6 justify-center">
                        <button onClick={() => setActiveTab('hira')} className={`px-6 py-2 rounded-full font-bold transition-all ${activeTab === 'hira' ? 'bg-jp-indigo text-white shadow-lg' : 'bg-white text-gray-500 border border-gray-200'}`}>平假名</button>
                        <button onClick={() => setActiveTab('kata')} className={`px-6 py-2 rounded-full font-bold transition-all ${activeTab === 'kata' ? 'bg-jp-indigo text-white shadow-lg' : 'bg-white text-gray-500 border border-gray-200'}`}>片假名</button>
                    </div>
                    <div className="bg-white/80 backdrop-blur-sm p-6 rounded-xl shadow-xl border border-stone-200">
                        {renderGrid(activeTab)}
                        <div className="mt-8"><h3 className="text-lg font-bold text-jp-dark mb-4 border-l-4 border-jp-indigo pl-3 font-jp-serif">濁音 / 半濁音</h3>
                            <div className="grid grid-cols-5 gap-2">{INITIAL_KANA.filter(k => (k.group === '濁音' || k.group === '半濁音') && k.type === (activeTab === 'hira' ? 'hira' : 'kata')).map((k, idx) => (<div key={idx} className="p-3 bg-white rounded border border-stone-200 text-center"><div className="text-xl font-bold font-jp-serif text-jp-dark">{k.char}</div><div className="text-xs text-gray-500">{k.romaji}</div></div>))}</div>
                        </div>
                        <div className="mt-8"><h3 className="text-lg font-bold text-jp-dark mb-4 border-l-4 border-jp-indigo pl-3 font-jp-serif">拗音 (部分)</h3>
                            <div className="grid grid-cols-5 gap-2">{INITIAL_KANA.filter(k => k.group === '拗音' && k.type === 'hira').map((k, idx) => (<div key={idx} className="p-3 bg-white rounded border border-stone-200 text-center"><div className="text-xl font-bold font-jp-serif text-jp-dark">{k.char}</div><div className="text-xs text-gray-500">{k.romaji}</div></div>))}</div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 測驗頁面 ---
        const QuizPage = ({ mode, onBack, vocabData }) => {
            const [gameState, setGameState] = useState('ready');
            const [questions, setQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [inputValue, setInputValue] = useState('');
            const [score, setScore] = useState(0);
            const [feedback, setFeedback] = useState(null); 
            const [history, setHistory] = useState([]); 
            const inputRef = useRef(null);
            const nextBtnRef = useRef(null);

            useEffect(() => { if(gameState === 'playing' && !feedback && inputRef.current) setTimeout(() => inputRef.current.focus(), 50); }, [gameState, currentIndex, feedback]);
            useEffect(() => { if(feedback && nextBtnRef.current) setTimeout(() => nextBtnRef.current.focus(), 50); }, [feedback]);
            useEffect(() => { if(gameState === 'ready') generateQuestions(); }, [gameState]);

            const generateQuestions = () => {
                let qList = [];
                const pool = vocabData.length > 0 ? vocabData : []; 
                
                if ((mode.includes('vocab') && pool.length === 0)) {
                    alert("單字庫是空的！請先到「管理單字庫」匯入 CSV 單字。\n(若已匯入請稍待雲端同步)");
                    onBack();
                    return;
                }

                for(let i=0; i<20; i++) {
                    if(mode === 'vocab_spell') {
                        const item = pool[Math.floor(Math.random() * pool.length)];
                        qList.push({ q: item.word, a: item.romaji, displayA: item.romaji, meaning: item.meaning, hint: '請輸入羅馬拼音' });
                    }
                    else if(mode === 'vocab_reverse') {
                        const item = pool[Math.floor(Math.random() * pool.length)];
                        qList.push({ q: item.meaning, a: item.word, displayA: item.word, romaji: item.romaji, hint: '請輸入日文', meaning: item.meaning });
                    }
                    else if(mode === 'kana_single') {
                        const k = KANA_QUIZ_POOL[Math.floor(Math.random() * KANA_QUIZ_POOL.length)];
                        qList.push({ q: k.char, a: k.romaji, displayA: k.romaji, hint: '羅馬拼音' });
                    }
                    else if(mode === 'kana_combo') {
                       const k1 = KANA_QUIZ_POOL[Math.floor(Math.random() * KANA_QUIZ_POOL.length)];
                       const k2 = KANA_QUIZ_POOL[Math.floor(Math.random() * KANA_QUIZ_POOL.length)];
                       const k3 = KANA_QUIZ_POOL[Math.floor(Math.random() * KANA_QUIZ_POOL.length)];
                       qList.push({ q: `${k1.char}${k2.char}${k3.char}`, a: `${k1.romaji}${k2.romaji}${k3.romaji}`, displayA: `${k1.romaji}${k2.romaji}${k3.romaji}`, hint: '連續拼音' });
                    }
                }
                setQuestions(qList); setGameState('playing'); setCurrentIndex(0); setScore(0); setHistory([]); setInputValue(''); setFeedback(null);
            };

            const handleSubmit = () => {
                if (!inputValue.trim()) return;
                const currentQ = questions[currentIndex];
                const isCorrect = inputValue.trim().toLowerCase() === currentQ.a.toLowerCase();
                if (isCorrect) setScore(prev => prev + 5);
                setFeedback({
                    type: isCorrect ? 'correct' : 'wrong',
                    msg: isCorrect ? '回答正確！' : '回答錯誤',
                    correctAns: currentQ.displayA,
                    romaji: currentQ.romaji, 
                    detail: currentQ.meaning ? `字義: ${currentQ.meaning}` : '',
                    userA: inputValue
                });
            };

            const nextQuestion = () => {
                setHistory([...history, { ...questions[currentIndex], userAnswer: feedback.userA, isCorrect: feedback.type === 'correct' }]);
                setFeedback(null); setInputValue('');
                if (currentIndex < 19) setCurrentIndex(prev => prev + 1);
                else setGameState('finished');
            };

            if (gameState === 'finished') return (
                <div className="max-w-2xl mx-auto p-6 text-center animate-slideIn">
                    <h2 className="text-3xl font-bold mb-6 text-jp-indigo font-jp-serif">測驗結果</h2>
                    <div className="bg-white p-8 rounded-xl shadow-xl mb-8 border border-stone-200">
                        <div className="text-6xl font-black text-jp-indigo mb-4">{score} <span className="text-2xl text-gray-400 font-medium">分</span></div>
                        <div className="h-96 overflow-y-auto border rounded-xl bg-gray-50 p-4 text-left">
                            <table className="w-full">
                                <thead><tr className="text-gray-400 text-sm border-b"><th className="pb-2 text-left">題目</th><th className="pb-2 text-center">您的回答</th><th className="pb-2 text-right">正確答案</th></tr></thead>
                                <tbody>{history.map((h,i) => (<tr key={i} className={`border-b last:border-0 ${h.isCorrect?'bg-emerald-50':'bg-red-50'}`}><td className="py-3 font-bold text-gray-800">{h.q}</td><td className={`py-3 text-center ${h.isCorrect?'text-emerald-600 font-bold':'text-jp-red line-through'}`}>{h.userAnswer}</td><td className="py-3 text-right text-jp-indigo font-bold">{h.displayA}</td></tr>))}</tbody>
                            </table>
                        </div>
                    </div>
                    <Button onClick={onBack} variant="secondary">返回</Button>
                </div>
            );

            if (gameState === 'playing' && questions.length > 0) {
                const q = questions[currentIndex];
                return (
                    <div className="max-w-xl mx-auto p-6 min-h-screen flex flex-col animate-slideIn">
                        <div className="flex items-center mb-4"><Button variant="ghost" onClick={onBack}><LucideIcon name="ChevronLeft" /> 退出</Button><div className="flex-1 text-center font-bold text-gray-400 font-jp-serif">問題 {currentIndex + 1} / 20</div></div>
                        <div className="bg-white rounded-xl shadow-2xl p-10 text-center relative flex-1 flex flex-col justify-center border border-stone-100">
                            <div className="text-6xl font-black text-jp-dark font-jp-serif mb-6">{q.q}</div>
                            {mode === 'vocab_spell' && <div className="text-gray-500 mb-8">{q.meaning}</div>}
                            <input ref={inputRef} type="text" value={inputValue} onChange={e=>setInputValue(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleSubmit()} placeholder={q.hint} className="w-full text-center text-2xl p-4 border-b-2 border-stone-200 focus:border-jp-indigo outline-none bg-transparent transition-colors" autoComplete="off" />
                        </div>
                        {feedback && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-40 backdrop-blur-sm">
                                <div className="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full text-center border-t-4 border-jp-indigo">
                                    <div className={`mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-4 ${feedback.type === 'correct' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-jp-red'}`}>{feedback.type === 'correct' ? <LucideIcon name="CheckCircle" size={40} /> : <LucideIcon name="XCircle" size={40} />}</div>
                                    <h3 className="text-2xl font-bold mb-2 font-jp-serif">{feedback.msg}</h3>
                                    {feedback.type === 'wrong' && <div className="bg-stone-50 p-4 rounded-lg mb-4 border border-stone-100"><div className="text-xs text-gray-500 font-bold mb-1">正確答案</div><div className="text-3xl font-black text-jp-dark font-jp-serif">{feedback.correctAns}</div>{feedback.romaji && <div className="text-sm text-jp-indigo font-mono mt-1">{feedback.romaji}</div>}</div>}
                                    {feedback.detail && <p className="text-gray-500 mb-4">{feedback.detail}</p>}
                                    <Button ref={nextBtnRef} onClick={nextQuestion} className="w-full">下一題 (Enter)</Button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
            return <div>Loading...</div>;
        };

        // --- 單字庫頁面 (CSV 管理) ---
        const VocabLibraryPage = ({ onBack, vocabList, setVocabList, user, syncId }) => {
            const [isAdding, setIsAdding] = useState(false);
            const [newWord, setNewWord] = useState({ word: '', romaji: '', meaning: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [currentPage, setCurrentPage] = useState(1);
            const [importStatus, setImportStatus] = useState({ loading: false, progress: '' });
            const fileInputRef = useRef(null);
            
            const filtered = vocabList.filter(v => v.word.includes(searchTerm) || v.meaning.includes(searchTerm));
            const totalPages = Math.ceil(filtered.length / 50) || 1;
            const paginated = filtered.slice((currentPage-1)*50, currentPage*50);

            // CSV 匯出
            const handleExportCSV = () => {
                const header = "編號,日文單字,拼音,字義\n";
                const rows = vocabList.map((v, i) => `${i+1},${v.word},${v.romaji},${v.meaning}`).join('\n');
                const blob = new Blob(["\uFEFF"+header + rows], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `日文單字庫_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            };

            // CSV 匯入
            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                setImportStatus({ loading: true, progress: '讀取檔案並檢查重複...' });
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const text = event.target.result;
                    const lines = text.split('\n');
                    
                    const existingWords = new Set(vocabList.map(v => v.word));
                    let newItems = [];
                    let duplicateCount = 0;

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line || line.startsWith('編號')) continue; 
                        
                        const parts = line.split(',');
                        if (parts.length >= 3) {
                            let word, romaji, meaning;
                            if (parts.length === 4) { [, word, romaji, meaning] = parts; }
                            else { [word, romaji, meaning] = parts; }
                            
                            word = word?.trim();
                            if (word && romaji) {
                                if (existingWords.has(word)) {
                                    duplicateCount++;
                                    continue;
                                }
                                newItems.push({
                                    word: word,
                                    romaji: romaji.trim(),
                                    meaning: (meaning || '').trim(),
                                    id: Date.now() + Math.random() + i 
                                });
                                existingWords.add(word);
                            }
                        }
                    }

                    if (newItems.length === 0) {
                         alert(`未匯入任何資料。\n(發現 ${duplicateCount} 筆重複資料)`);
                         setImportStatus({ loading: false, progress: '' });
                         e.target.value = null;
                         return;
                    }

                    if (user && window.firebase) {
                        try {
                            const db = firebase.firestore();
                            const batchLimit = 400; 
                            let batch = db.batch();
                            let batchCount = 0;
                            let totalUploaded = 0;
                            
                            for (let i = 0; i < newItems.length; i++) {
                                const item = newItems[i];
                                const newDocRef = db.collection('user_vocab').doc();
                                batch.set(newDocRef, {
                                    word: item.word,
                                    romaji: item.romaji,
                                    meaning: item.meaning,
                                    userId: syncId || user.uid, // 使用 SyncID
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                batchCount++;
                                
                                if (batchCount >= batchLimit) {
                                    setImportStatus({ loading: true, progress: `正在同步到雲端... (${totalUploaded}/${newItems.length})` });
                                    await batch.commit();
                                    totalUploaded += batchCount;
                                    batch = db.batch();
                                    batchCount = 0;
                                }
                            }
                            if (batchCount > 0) {
                                setImportStatus({ loading: true, progress: `正在同步到雲端... (${totalUploaded}/${newItems.length})` });
                                await batch.commit();
                            }
                            
                            alert(`成功匯入 ${newItems.length} 筆單字！\n(已自動跳過 ${duplicateCount} 筆重複資料)`);
                        } catch(e) {
                            console.error(e);
                            alert("匯入雲端失敗，請檢查網路。錯誤: " + e.message);
                            setVocabList(prev => [...newItems, ...prev]);
                        }
                    } else {
                        setVocabList(prev => [...newItems, ...prev]);
                        alert(`已匯入 ${newItems.length} 筆單字 (離線模式)\n(已跳過 ${duplicateCount} 筆重複)`);
                    }
                    
                    setImportStatus({ loading: false, progress: '' });
                    e.target.value = null; 
                };
                reader.readAsText(file);
            };

            const handleAdd = async () => {
                if(!newWord.word) return;
                
                if (vocabList.some(v => v.word === newWord.word)) {
                    alert('單字庫中已經有這個單字了！');
                    return;
                }

                const tempItem = { ...newWord, id: Date.now(), userId: syncId || user?.uid };
                
                if(!user) {
                    setVocabList(prev => [tempItem, ...prev]);
                }

                if(user && window.firebase) {
                    try {
                        await firebase.firestore().collection('user_vocab').add({
                            ...newWord, 
                            userId: syncId || user.uid, // 使用 SyncID
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch(e) { console.error(e); }
                }
                setNewWord({ word: '', romaji: '', meaning: '' });
                setIsAdding(false);
            };

            const handleDelete = async (id) => {
                if(!confirm('確定刪除此單字？')) return;
                
                if(user && window.firebase) {
                    try {
                        await firebase.firestore().collection('user_vocab').doc(id).delete();
                    } catch(e) { console.log('Delete failed', e); }
                } else {
                    setVocabList(prev => prev.filter(v => v.id !== id)); 
                }
            };

            return (
                <div className="max-w-5xl mx-auto p-4 animate-slideIn">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div className="flex items-center"><Button variant="ghost" onClick={onBack}><LucideIcon name="ChevronLeft" /> 返回</Button><h2 className="text-2xl font-bold ml-2 text-jp-dark font-jp-serif">管理單字庫</h2></div>
                        <div className="flex items-center gap-2"><LucideIcon name="Search" size={18} className="text-jp-indigo"/><input className="border border-stone-300 rounded-full px-4 py-2 w-full md:w-64 focus:border-jp-indigo focus:ring-1 focus:ring-jp-indigo outline-none bg-white/80" placeholder="搜尋單字..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} /></div>
                    </div>
                    
                    <div className="mb-4 p-4 bg-white/60 backdrop-blur-sm rounded-xl border border-stone-200 flex flex-col md:flex-row justify-between items-center gap-4 shadow-sm">
                        <div className="flex items-center gap-2 text-jp-indigo text-sm font-medium">
                            <LucideIcon name="Cloud" size={16}/> {user ? '雲端同步中' : '離線模式'} 
                            <span className="font-bold ml-2 text-jp-dark">總字數: {vocabList.length}</span>
                        </div>
                        <div className="flex gap-2 flex-wrap justify-center">
                            <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".csv" className="hidden" />
                            <Button onClick={() => fileInputRef.current.click()} variant="secondary" className="text-xs py-2" disabled={importStatus.loading}>
                                {importStatus.loading ? <><LucideIcon name="RotateCcw" className="animate-spin mr-1" size={14}/> {importStatus.progress}</> : <><LucideIcon name="Upload" size={14}/> 匯入 CSV</>}
                            </Button>
                            <Button onClick={handleExportCSV} variant="light" className="text-xs py-2"><LucideIcon name="Download" size={14}/> 匯出 CSV</Button>
                            <Button onClick={()=>setIsAdding(true)} variant="primary" className="text-xs py-2"><LucideIcon name="Plus" size={14}/> 新增</Button>
                        </div>
                    </div>

                    {isAdding && (
                        <div className="bg-white p-6 rounded-xl shadow-lg mb-6 border-l-4 border-jp-indigo animate-slideIn">
                            <h3 className="font-bold mb-4 text-jp-dark font-jp-serif text-lg">新增單字</h3>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label className="text-xs text-gray-500 mb-1 block">日文</label>
                                    <input className="border p-2 rounded w-full focus:border-jp-indigo outline-none" placeholder="例: 私" value={newWord.word} onChange={e=>setNewWord({...newWord, word:e.target.value})} />
                                </div>
                                <div>
                                    <label className="text-xs text-gray-500 mb-1 block">羅馬拼音</label>
                                    <input className="border p-2 rounded w-full focus:border-jp-indigo outline-none" placeholder="例: watashi" value={newWord.romaji} onChange={e=>setNewWord({...newWord, romaji:e.target.value})} />
                                </div>
                                <div>
                                    <label className="text-xs text-gray-500 mb-1 block">中文意思</label>
                                    <input className="border p-2 rounded w-full focus:border-jp-indigo outline-none" placeholder="例: 我" value={newWord.meaning} onChange={e=>setNewWord({...newWord, meaning:e.target.value})} />
                                </div>
                                <div className="flex gap-2 items-end">
                                    <Button onClick={handleAdd} className="flex-1">儲存</Button>
                                    <Button onClick={() => setIsAdding(false)} variant="light" className="flex-1">取消</Button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="bg-white rounded-xl shadow-md border border-stone-200 overflow-hidden">
                        <div className="grid grid-cols-12 bg-stone-50 p-3 text-sm font-bold text-gray-600 border-b border-stone-200"><div className="col-span-1">#</div><div className="col-span-3">日文</div><div className="col-span-3">拼音</div><div className="col-span-4">意思</div><div className="col-span-1"></div></div>
                        <div className="divide-y divide-stone-100">
                            {paginated.map((v, i) => (
                                <div key={v.id} className="grid grid-cols-12 p-3 hover:bg-stone-50 items-center text-sm transition-colors">
                                    <div className="col-span-1 text-gray-400 font-mono">{i+1 + (currentPage-1)*50}</div>
                                    <div className="col-span-3 font-bold font-jp-serif text-jp-dark text-lg">{v.word}</div>
                                    <div className="col-span-3 font-mono text-jp-indigo text-xs">{v.romaji}</div>
                                    <div className="col-span-4 text-gray-600">{v.meaning}</div>
                                    <div className="col-span-1 text-right"><button onClick={()=>handleDelete(v.id)} className="text-gray-300 hover:text-jp-red transition-colors"><LucideIcon name="Trash2" size={16}/></button></div>
                                </div>
                            ))}
                            {paginated.length===0 && <div className="p-12 text-center text-gray-400">目前無單字。<br/>請點擊上方按鈕匯入 CSV 檔案。</div>}
                        </div>
                    </div>
                    
                    <div className="flex justify-center items-center mt-6 gap-6">
                        <button disabled={currentPage===1} onClick={()=>setCurrentPage(p=>p-1)} className="p-2 bg-white rounded-full shadow border border-gray-200 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all"><LucideIcon name="ChevronLeft" /></button>
                        <span className="py-2 text-jp-dark font-bold font-mono text-sm">第 {currentPage} / {totalPages} 頁</span>
                        <button disabled={currentPage >= totalPages} onClick={()=>setCurrentPage(p=>p+1)} className="p-2 bg-white rounded-full shadow border border-gray-200 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all"><LucideIcon name="ChevronRight" /></button>
                    </div>
                </div>
            );
        };

        // --- 主程式 ---
        function App() {
            const [view, setView] = useState('home');
            const [user, setUser] = useState(null);
            const [vocabList, setVocabList] = useState([]);
            const [dbStatus, setDbStatus] = useState('init'); // init, connecting, connected, offline
            const [showSyncModal, setShowSyncModal] = useState(false);
            const [syncId, setSyncId] = useState(localStorage.getItem('japanese_app_sync_id') || '');
            const [tempSyncId, setTempSyncId] = useState('');
            const [isMigrating, setIsMigrating] = useState(false);

            // 監聽 Firebase 登入狀態
            useEffect(() => {
                if (window.firebase) {
                    setDbStatus('connecting');
                    const unsubscribe = window.firebase.auth().onAuthStateChanged(u => {
                        setUser(u);
                        if(u) setDbStatus('connected');
                        else setDbStatus('offline');
                    });
                    
                    window.firebase.auth().signInAnonymously()
                        .then(() => console.log("Signed in anonymously"))
                        .catch(err => {
                            console.error("Auth failed", err);
                            setDbStatus('offline');
                        });
                        
                    return () => unsubscribe();
                } else {
                    setDbStatus('offline');
                }
            }, []);

            // 監聽雲端資料 - 使用 syncId 或 user.uid
            useEffect(() => {
                if (user && window.firebase) {
                    const db = window.firebase.firestore();
                    // 如果有設定 syncId 就用 syncId，否則用匿名登入的 uid
                    const targetId = syncId || user.uid;
                    
                    console.log("Listening to data for:", targetId);

                    const unsubscribe = db.collection('user_vocab')
                        .where('userId', '==', targetId)
                        .onSnapshot(snapshot => {
                            const list = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                            list.sort((a, b) => {
                                const ta = a.createdAt?.seconds || 0;
                                const tb = b.createdAt?.seconds || 0;
                                return ta - tb;
                            });
                            setVocabList(list);
                        }, error => {
                            console.error("Snapshot error:", error);
                        });
                    return () => unsubscribe();
                }
            }, [user, syncId]);

            // 處理同步 ID 設定
            const handleSaveSyncId = async (shouldMigrate) => {
                if (!tempSyncId.trim()) {
                    alert("請輸入有效的 ID");
                    return;
                }
                
                const newId = tempSyncId.trim();
                const oldId = syncId || user?.uid;

                if (shouldMigrate && user && window.firebase) {
                    setIsMigrating(true);
                    try {
                        const db = window.firebase.firestore();
                        // 1. 抓出舊 ID 的所有資料
                        const snapshot = await db.collection('user_vocab').where('userId', '==', oldId).get();
                        
                        if (snapshot.empty) {
                            alert("目前沒有資料可以轉移。");
                        } else {
                            // 2. 批次更新 (Firestore 批次上限 500)
                            const batch = db.batch();
                            snapshot.docs.forEach(doc => {
                                batch.update(doc.ref, { userId: newId });
                            });
                            await batch.commit();
                            alert(`已成功轉移 ${snapshot.size} 筆資料到新 ID！`);
                        }
                    } catch(e) {
                        console.error(e);
                        alert("轉移失敗：" + e.message);
                        setIsMigrating(false);
                        return; // 失敗不切換 ID
                    }
                    setIsMigrating(false);
                }

                // 儲存並切換 ID
                localStorage.setItem('japanese_app_sync_id', newId);
                setSyncId(newId);
                setShowSyncModal(false);
                alert(`同步 ID 已設定為：${newId}\n請在其他裝置輸入相同 ID 即可同步。`);
            };

            const openSyncModal = () => {
                setTempSyncId(syncId || '');
                setShowSyncModal(true);
            };

            if (view === 'home') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 relative overflow-hidden">
                    {/* 背景裝飾 */}
                    <div className="absolute top-10 left-10 text-jp-pink/20 animate-float" style={{animationDelay:'0s'}}><LucideIcon name="Flower" size={60} /></div>
                    <div className="absolute bottom-20 right-20 text-jp-pink/20 animate-float" style={{animationDelay:'2s'}}><LucideIcon name="Flower" size={80} /></div>
                    <div className="absolute top-40 right-10 text-jp-pink/10 animate-float" style={{animationDelay:'4s'}}><LucideIcon name="Flower" size={40} /></div>
                    
                    {/* 右上角同步設定按鈕 */}
                    <button onClick={openSyncModal} className="absolute top-6 right-6 p-2 bg-white/80 backdrop-blur rounded-full shadow-md text-jp-indigo hover:bg-jp-indigo hover:text-white transition-all z-20" title="同步設定">
                        <LucideIcon name="Settings" size={24} />
                    </button>

                    <div className="z-10 text-center">
                        <div className="mb-2 text-jp-red font-bold tracking-[0.2em] text-sm uppercase">Japanese Learning System</div>
                        <h1 className="text-5xl font-black text-jp-dark mb-4 font-jp-serif">日本語学習</h1>
                        <p className="text-gray-500 mb-8 font-jp-serif">日々の積み重ねが、未来を創る。</p>
                        
                        {/* 資料庫連線狀態顯示 */}
                        <div className="mb-12 inline-flex items-center gap-2 px-5 py-2 bg-white/80 backdrop-blur rounded-full shadow-sm text-sm border border-stone-200">
                            {dbStatus === 'connecting' && <><LucideIcon name="Loader2" className="animate-spin text-jp-indigo" size={16}/> <span className="text-gray-600">連線資料庫中...</span></>}
                            {dbStatus === 'connected' && <><div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse shadow-[0_0_8px_rgba(16,185,129,0.5)]"></div> <span className="text-gray-700 font-medium">資料庫已連線</span></>}
                            {dbStatus === 'offline' && <><LucideIcon name="WifiOff" className="text-gray-400" size={16}/> <span className="text-gray-400">離線模式 (資料僅暫存)</span></>}
                        </div>

                        <div className="grid md:grid-cols-2 gap-8 w-full max-w-3xl mx-auto">
                            <div onClick={()=>setView('kana_menu')} className="bg-white p-8 rounded-xl shadow-xl hover:-translate-y-2 transition-all cursor-pointer border-t-4 border-jp-pink group relative overflow-hidden">
                                <div className="absolute -right-4 -bottom-4 text-jp-pink/10 group-hover:text-jp-pink/20 transition-colors"><span className="text-9xl font-jp-serif">あ</span></div>
                                <span className="text-5xl text-jp-pink font-bold block mb-4 group-hover:scale-110 transition-transform origin-left font-jp-serif">あ</span>
                                <h2 className="text-xl font-bold text-jp-dark relative z-10">五十音練習</h2>
                                <p className="text-sm text-gray-400 mt-2 relative z-10">基礎假名、發音、拼音測驗</p>
                            </div>
                            <div onClick={()=>setView('vocab_menu')} className="bg-white p-8 rounded-xl shadow-xl hover:-translate-y-2 transition-all cursor-pointer border-t-4 border-jp-indigo group relative overflow-hidden">
                                <div className="absolute -right-4 -bottom-4 text-jp-indigo/5 group-hover:text-jp-indigo/10 transition-colors"><LucideIcon name="Book" size={120} /></div>
                                <div className="text-jp-indigo mb-4 group-hover:scale-110 transition-transform origin-left"><LucideIcon name="Book" size={48} /></div>
                                <h2 className="text-xl font-bold text-jp-dark relative z-10">單字練習</h2>
                                <p className="text-sm text-gray-400 mt-2 relative z-10">單字庫管理、中翻日測驗 <span className="bg-jp-indigo text-white text-xs px-2 py-0.5 rounded-full ml-1">{vocabList.length}</span></p>
                            </div>
                        </div>
                    </div>
                    
                    <div className="absolute bottom-6 text-gray-300 text-xs font-mono">Design by Japanese Learning App</div>

                    {/* 同步設定 Modal */}
                    {showSyncModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-slideIn">
                            <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full relative">
                                <button onClick={()=>setShowSyncModal(false)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><LucideIcon name="XCircle" size={24}/></button>
                                <h3 className="text-2xl font-bold mb-4 font-jp-serif text-jp-dark flex items-center gap-2"><LucideIcon name="Settings" /> 同步設定</h3>
                                <div className="mb-6 text-sm text-gray-600">
                                    <p className="mb-2">由於目前使用匿名登入，不同裝置的資料預設是不互通的。</p>
                                    <p>請設定一個自訂的 <strong>「同步 ID」</strong> (如手機號碼)，並在所有裝置輸入相同的 ID 即可同步資料。</p>
                                </div>
                                <div className="mb-6">
                                    <label className="block text-xs font-bold text-jp-indigo mb-1">您的同步 ID</label>
                                    <input 
                                        type="text" 
                                        value={tempSyncId} 
                                        onChange={e=>setTempSyncId(e.target.value)} 
                                        placeholder="請輸入 ID (例: my-phone-number)"
                                        className="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-jp-indigo outline-none font-mono text-lg"
                                    />
                                    {syncId && <div className="mt-2 text-xs text-emerald-600 flex items-center gap-1"><LucideIcon name="CheckCircle" size={12}/> 目前使用中: {syncId}</div>}
                                </div>
                                <div className="flex flex-col gap-3">
                                    <Button onClick={()=>handleSaveSyncId(false)} disabled={isMigrating} className="w-full justify-center">
                                        {isMigrating ? '處理中...' : (syncId ? '切換 ID (不轉移資料)' : '設定 ID')}
                                    </Button>
                                    {/* 只有在目前有資料且尚未設定 ID 時才顯示轉移選項，或者更換 ID 時 */}
                                    {vocabList.length > 0 && (
                                        <Button onClick={()=>handleSaveSyncId(true)} variant="secondary" disabled={isMigrating} className="w-full justify-center">
                                            <LucideIcon name="RotateCcw" size={16}/> 設定並轉移現有資料 ({vocabList.length}筆)
                                        </Button>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );

            if (view === 'kana_menu') return (
                <div className="min-h-screen p-6 max-w-md mx-auto flex flex-col justify-center gap-4 relative">
                     <div className="absolute top-0 left-0 w-full h-full pointer-events-none opacity-20" style={{backgroundImage: 'radial-gradient(#b91c1c 0.5px, transparent 0.5px)', backgroundSize: '30px 30px'}}></div>
                    <Button variant="ghost" onClick={()=>setView('home')} className="self-start relative z-10"><LucideIcon name="Home"/> 首頁</Button>
                    <div className="bg-white/80 backdrop-blur p-8 rounded-2xl shadow-xl border border-stone-100 relative z-10">
                        <h2 className="text-3xl font-bold text-center mb-8 text-jp-dark font-jp-serif border-b pb-4">五十音練習</h2>
                        <div className="space-y-3">
                            <Button onClick={()=>setView('kana_table')} variant="secondary" className="w-full justify-between">五十音表 <LucideIcon name="ChevronRight" size={16}/></Button>
                            <Button onClick={()=>setView('quiz_kana_single')} className="w-full justify-between bg-jp-indigo hover:bg-indigo-900 text-white">拼音練習 (單字) <LucideIcon name="Brain" size={16}/></Button>
                            <Button onClick={()=>setView('quiz_kana_combo')} className="w-full justify-between bg-jp-indigo hover:bg-indigo-900 text-white">連續拼音 (組合) <LucideIcon name="Brain" size={16}/></Button>
                            <Button onClick={()=>setView('quiz_vocab_spell')} className="w-full justify-between bg-jp-red hover:bg-red-800 text-white border-none">日文單字拼音 <LucideIcon name="CheckCircle" size={16}/></Button>
                        </div>
                    </div>
                </div>
            );

            if (view === 'vocab_menu') return (
                <div className="min-h-screen p-6 max-w-md mx-auto flex flex-col justify-center gap-4 relative">
                    <div className="absolute top-0 left-0 w-full h-full pointer-events-none opacity-20" style={{backgroundImage: 'radial-gradient(#1e3a8a 0.5px, transparent 0.5px)', backgroundSize: '30px 30px'}}></div>
                    <Button variant="ghost" onClick={()=>setView('home')} className="self-start relative z-10"><LucideIcon name="Home"/> 首頁</Button>
                    <div className="bg-white/80 backdrop-blur p-8 rounded-2xl shadow-xl border border-stone-100 relative z-10">
                        <h2 className="text-3xl font-bold text-center mb-2 text-jp-dark font-jp-serif">單字練習</h2>
                        <p className="text-center text-gray-500 mb-8 text-sm">目前的單字量: <span className="font-bold text-jp-indigo text-lg">{vocabList.length}</span></p>
                        <div className="space-y-3">
                            <Button onClick={()=>setView('vocab_lib')} variant="secondary" className="w-full justify-between">管理單字庫 <LucideIcon name="ChevronRight" size={16}/></Button>
                            <Button onClick={()=>setView('quiz_vocab_reverse')} className="w-full justify-between bg-jp-indigo hover:bg-indigo-900 text-white">中翻日練習 (填日文) <LucideIcon name="Brain" size={16}/></Button>
                        </div>
                    </div>
                </div>
            );

            if (view === 'kana_table') return <KanaTablePage onBack={()=>setView('kana_menu')} />;
            if (view === 'vocab_lib') return <VocabLibraryPage onBack={()=>setView('vocab_menu')} vocabList={vocabList} setVocabList={setVocabList} user={user} syncId={syncId} />;
            
            // 路由處理
            const isQuiz = view.startsWith('quiz_');
            if (isQuiz) {
                const mode = view.replace('quiz_', '');
                return <QuizPage mode={mode} onBack={()=>setView(mode.includes('vocab') ? 'vocab_menu' : 'kana_menu')} vocabData={vocabList} />;
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
