<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>日文自學系統 | Japanese Learning</title>
    
    <!-- 1. 載入 React 核心 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 2. 載入 Babel (解析 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. 載入 Tailwind CSS (樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 4. 載入 Firebase SDK (Compat 版本 - 適合單一 HTML) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif;
            background-color: #fdfbf7;
            color: #2d3748;
            -webkit-font-smoothing: antialiased;
        }
        
        .font-sans { font-family: 'Noto Sans JP', sans-serif; }
        
        /* 自訂捲軸 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
        
        /* 動畫效果 */
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slideIn { animation: slideIn 0.4s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- 內建 SVG Icons (解決 CDN 報錯問題) ---
        const Icon = ({ path, className = "", size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d={path} />
            </svg>
        );

        // 定義所有用到的圖示路徑
        const ICONS = {
            Book: "M4 19.5A2.5 2.5 0 0 1 6.5 17H20M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z",
            ChevronLeft: "M15 18l-6-6 6-6",
            ChevronRight: "M9 18l6-6-6-6",
            Trash2: "M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6",
            Download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3",
            Upload: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12",
            Plus: "M12 5v14M5 12h14",
            RotateCcw: "M1 4v6h6M3.51 15a9 9 0 1 0 2.13-9.36L1 10",
            CheckCircle: "M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4L12 14.01l-3-3",
            XCircle: "M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 1 1-18 0 9 9 0 0 1 18 0z",
            Search: "M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16z M21 21l-4.35-4.35",
            Cloud: "M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z",
            Loader2: "M21 12a9 9 0 1 1-6.219-8.56", // 需配合 animate-spin class
            WifiOff: "M1 1l22 22 M16.72 11.06A10.94 10.94 0 0 1 19 12.55 M5 12.55a10.94 10.94 0 0 1 5.17-2.39 M10.71 5.05A16 16 0 0 1 22.58 9 M1.42 9a15.91 15.91 0 0 1 4.7-2.88 M8.53 16.11a6 6 0 0 1 6.95 0 M12 20h.01",
        };

        // 簡單的圖示元件封裝
        const LucideIcon = ({ name, ...props }) => {
            const path = ICONS[name];
            if (!path) return <span>?</span>;
            return <Icon path={path} {...props} />;
        };

        // --- Firebase 設定 (移至組件外) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCBOmSZTrEqti7TnCFaSfZlXCmjVqY7mn8",
            authDomain: "japanese-2faca.firebaseapp.com",
            projectId: "japanese-2faca",
            storageBucket: "japanese-2faca.firebasestorage.app",
            messagingSenderId: "423393532516",
            appId: "1:423393532516:web:1bdd2baf986b377542dd71",
            measurementId: "G-NVRF6XDB83"
        };

        // 初始化 Firebase 防止重複初始化
        if (window.firebase && !window.firebase.apps.length) {
            try {
                window.firebase.initializeApp(firebaseConfig);
                console.log("Firebase initialized successfully");
            } catch(e) {
                console.error("Firebase init failed:", e);
            }
        }

        // --- 五十音資料 (固定資料) ---
        const INITIAL_KANA = [
            { char: 'あ', romaji: 'a', type: 'hira', group: '清音' }, { char: 'い', romaji: 'i', type: 'hira', group: '清音' }, { char: 'う', romaji: 'u', type: 'hira', group: '清音' }, { char: 'え', romaji: 'e', type: 'hira', group: '清音' }, { char: 'お', romaji: 'o', type: 'hira', group: '清音' },
            { char: 'か', romaji: 'ka', type: 'hira', group: '清音' }, { char: 'き', romaji: 'ki', type: 'hira', group: '清音' }, { char: 'く', romaji: 'ku', type: 'hira', group: '清音' }, { char: 'け', romaji: 'ke', type: 'hira', group: '清音' }, { char: 'こ', romaji: 'ko', type: 'hira', group: '清音' },
            { char: 'さ', romaji: 'sa', type: 'hira', group: '清音' }, { char: 'し', romaji: 'shi', type: 'hira', group: '清音' }, { char: 'す', romaji: 'su', type: 'hira', group: '清音' }, { char: 'せ', romaji: 'se', type: 'hira', group: '清音' }, { char: 'そ', romaji: 'so', type: 'hira', group: '清音' },
            { char: 'た', romaji: 'ta', type: 'hira', group: '清音' }, { char: 'ち', romaji: 'chi', type: 'hira', group: '清音' }, { char: 'つ', romaji: 'tsu', type: 'hira', group: '清音' }, { char: 'て', romaji: 'te', type: 'hira', group: '清音' }, { char: 'と', romaji: 'to', type: 'hira', group: '清音' },
            { char: 'な', romaji: 'na', type: 'hira', group: '清音' }, { char: 'に', romaji: 'ni', type: 'hira', group: '清音' }, { char: 'ぬ', romaji: 'nu', type: 'hira', group: '清音' }, { char: 'ね', romaji: 'ne', type: 'hira', group: '清音' }, { char: 'の', romaji: 'no', type: 'hira', group: '清音' },
            { char: 'は', romaji: 'ha', type: 'hira', group: '清音' }, { char: 'ひ', romaji: 'hi', type: 'hira', group: '清音' }, { char: 'ふ', romaji: 'fu', type: 'hira', group: '清音' }, { char: 'へ', romaji: 'he', type: 'hira', group: '清音' }, { char: 'ほ', romaji: 'ho', type: 'hira', group: '清音' },
            { char: 'ま', romaji: 'ma', type: 'hira', group: '清音' }, { char: 'み', romaji: 'mi', type: 'hira', group: '清音' }, { char: 'む', romaji: 'mu', type: 'hira', group: '清音' }, { char: 'め', romaji: 'me', type: 'hira', group: '清音' }, { char: 'も', romaji: 'mo', type: 'hira', group: '清音' },
            { char: 'や', romaji: 'ya', type: 'hira', group: '清音' }, { char: '', romaji: '', type: 'hira', group: '清音' }, { char: 'ゆ', romaji: 'yu', type: 'hira', group: '清音' }, { char: '', romaji: '', type: 'hira', group: '清音' }, { char: 'よ', romaji: 'yo', type: 'hira', group: '清音' },
            { char: 'ら', romaji: 'ra', type: 'hira', group: '清音' }, { char: 'り', romaji: 'ri', type: 'hira', group: '清音' }, { char: 'る', romaji: 'ru', type: 'hira', group: '清音' }, { char: 'れ', romaji: 're', type: 'hira', group: '清音' }, { char: 'ろ', romaji: 'ro', type: 'hira', group: '清音' },
            { char: 'わ', romaji: 'wa', type: 'hira', group: '清音' }, { char: '', romaji: '', type: 'hira', group: '清音' }, { char: 'を', romaji: 'wo', type: 'hira', group: '清音' }, { char: '', romaji: '', type: 'hira', group: '清音' }, { char: 'ん', romaji: 'n', type: 'hira', group: '清音' },
            { char: 'ア', romaji: 'a', type: 'kata', group: '清音' }, { char: 'イ', romaji: 'i', type: 'kata', group: '清音' }, { char: 'ウ', romaji: 'u', type: 'kata', group: '清音' }, { char: 'エ', romaji: 'e', type: 'kata', group: '清音' }, { char: 'オ', romaji: 'o', type: 'kata', group: '清音' },
            { char: 'カ', romaji: 'ka', type: 'kata', group: '清音' }, { char: 'キ', romaji: 'ki', type: 'kata', group: '清音' }, { char: 'ク', romaji: 'ku', type: 'kata', group: '清音' }, { char: 'ケ', romaji: 'ke', type: 'kata', group: '清音' }, { char: 'コ', romaji: 'ko', type: 'kata', group: '清音' },
            { char: 'サ', romaji: 'sa', type: 'kata', group: '清音' }, { char: 'シ', romaji: 'shi', type: 'kata', group: '清音' }, { char: 'ス', romaji: 'su', type: 'kata', group: '清音' }, { char: 'セ', romaji: 'se', type: 'kata', group: '清音' }, { char: 'ソ', romaji: 'so', type: 'kata', group: '清音' },
            { char: 'タ', romaji: 'ta', type: 'kata', group: '清音' }, { char: 'チ', romaji: 'chi', type: 'kata', group: '清音' }, { char: 'ツ', romaji: 'tsu', type: 'kata', group: '清音' }, { char: 'テ', romaji: 'te', type: 'kata', group: '清音' }, { char: 'ト', romaji: 'to', type: 'kata', group: '清音' },
            { char: 'ナ', romaji: 'na', type: 'kata', group: '清音' }, { char: 'ニ', romaji: 'ni', type: 'kata', group: '清音' }, { char: 'ヌ', romaji: 'nu', type: 'kata', group: '清音' }, { char: 'ネ', romaji: 'ne', type: 'kata', group: '清音' }, { char: 'ノ', romaji: 'no', type: 'kata', group: '清音' },
            { char: 'ハ', romaji: 'ha', type: 'kata', group: '清音' }, { char: 'ヒ', romaji: 'hi', type: 'kata', group: '清音' }, { char: 'フ', romaji: 'fu', type: 'kata', group: '清音' }, { char: 'ヘ', romaji: 'he', type: 'kata', group: '清音' }, { char: 'ホ', romaji: 'ho', type: 'kata', group: '清音' },
            { char: 'マ', romaji: 'ma', type: 'kata', group: '清音' }, { char: 'ミ', romaji: 'mi', type: 'kata', group: '清音' }, { char: 'ム', romaji: 'mu', type: 'kata', group: '清音' }, { char: 'メ', romaji: 'me', type: 'kata', group: '清音' }, { char: 'モ', romaji: 'mo', type: 'kata', group: '清音' },
            { char: 'ヤ', romaji: 'ya', type: 'kata', group: '清音' }, { char: '', romaji: '', type: 'kata', group: '清音' }, { char: 'ユ', romaji: 'yu', type: 'kata', group: '清音' }, { char: '', romaji: '', type: 'kata', group: '清音' }, { char: 'ヨ', romaji: 'yo', type: 'kata', group: '清音' },
            { char: 'ラ', romaji: 'ra', type: 'kata', group: '清音' }, { char: 'リ', romaji: 'ri', type: 'kata', group: '清音' }, { char: 'ル', romaji: 'ru', type: 'kata', group: '清音' }, { char: 'レ', romaji: 're', type: 'kata', group: '清音' }, { char: 'ロ', romaji: 'ro', type: 'kata', group: '清音' },
            { char: 'ワ', romaji: 'wa', type: 'kata', group: '清音' }, { char: '', romaji: '', type: 'kata', group: '清音' }, { char: 'ヲ', romaji: 'wo', type: 'kata', group: '清音' }, { char: '', romaji: '', type: 'kata', group: '清音' }, { char: 'ン', romaji: 'n', type: 'kata', group: '清音' },

            { char: 'が', romaji: 'ga', type: 'hira', group: '濁音' }, { char: 'ぎ', romaji: 'gi', type: 'hira', group: '濁音' }, { char: 'ぐ', romaji: 'gu', type: 'hira', group: '濁音' }, { char: 'げ', romaji: 'ge', type: 'hira', group: '濁音' }, { char: 'ご', romaji: 'go', type: 'hira', group: '濁音' },
            { char: 'ざ', romaji: 'za', type: 'hira', group: '濁音' }, { char: 'じ', romaji: 'ji', type: 'hira', group: '濁音' }, { char: 'ず', romaji: 'zu', type: 'hira', group: '濁音' }, { char: 'ぜ', romaji: 'ze', type: 'hira', group: '濁音' }, { char: 'ぞ', romaji: 'zo', type: 'hira', group: '濁音' },
            { char: 'だ', romaji: 'da', type: 'hira', group: '濁音' }, { char: 'ぢ', romaji: 'ji', type: 'hira', group: '濁音' }, { char: 'づ', romaji: 'zu', type: 'hira', group: '濁音' }, { char: 'で', romaji: 'de', type: 'hira', group: '濁音' }, { char: 'ど', romaji: 'do', type: 'hira', group: '濁音' },
            { char: 'ば', romaji: 'ba', type: 'hira', group: '濁音' }, { char: 'び', romaji: 'bi', type: 'hira', group: '濁音' }, { char: 'ぶ', romaji: 'bu', type: 'hira', group: '濁音' }, { char: 'べ', romaji: 'be', type: 'hira', group: '濁音' }, { char: 'ぼ', romaji: 'bo', type: 'hira', group: '濁音' },
            { char: 'ぱ', romaji: 'pa', type: 'hira', group: '半濁音' }, { char: 'ぴ', romaji: 'pi', type: 'hira', group: '半濁音' }, { char: 'ぷ', romaji: 'pu', type: 'hira', group: '半濁音' }, { char: 'ぺ', romaji: 'pe', type: 'hira', group: '半濁音' }, { char: 'ぽ', romaji: 'po', type: 'hira', group: '半濁音' },
            { char: 'きゃ', romaji: 'kya', type: 'hira', group: '拗音' }, { char: 'きゅ', romaji: 'kyu', type: 'hira', group: '拗音' }, { char: 'きょ', romaji: 'kyo', type: 'hira', group: '拗音' },
            { char: 'しゃ', romaji: 'sha', type: 'hira', group: '拗音' }, { char: 'しゅ', romaji: 'shu', type: 'hira', group: '拗音' }, { char: 'しょ', romaji: 'sho', type: 'hira', group: '拗音' },
            { char: 'ちゃ', romaji: 'cha', type: 'hira', group: '拗音' }, { char: 'ちゅ', romaji: 'chu', type: 'hira', group: '拗音' }, { char: 'ちょ', romaji: 'cho', type: 'hira', group: '拗音' },
        ];

        const KANA_QUIZ_POOL = INITIAL_KANA.filter(k => k.char !== '');

        // --- 元件: Button ---
        const Button = React.forwardRef(({ children, onClick, className = "", variant = "primary", disabled = false, autoFocus, title }, ref) => {
            const baseStyle = "px-4 py-2 md:px-6 md:py-3 rounded-xl font-bold transition-all duration-200 transform active:scale-95 flex items-center justify-center gap-2 shadow-sm focus:ring-4 focus:ring-indigo-300 outline-none select-none";
            const variants = {
                primary: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-indigo-200",
                secondary: "bg-white text-indigo-600 border-2 border-indigo-100 hover:border-indigo-300",
                danger: "bg-red-50 text-red-600 hover:bg-red-100",
                success: "bg-green-600 text-white hover:bg-green-700",
                ghost: "bg-transparent text-gray-500 hover:text-gray-700 shadow-none px-2",
                light: "bg-gray-100 text-gray-600 hover:bg-gray-200"
            };
            return (
                <button ref={ref} onClick={onClick} disabled={disabled} autoFocus={autoFocus} title={title} className={`${baseStyle} ${variants[variant]} ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}>
                    {children}
                </button>
            );
        });

        // --- 頁面: 五十音練習 ---
        const KanaTablePage = ({ onBack }) => {
            const [activeTab, setActiveTab] = useState('hira');
            const renderGrid = (type) => (
                <div className="grid grid-cols-5 gap-2 md:gap-4 mb-6">
                    {INITIAL_KANA.filter(k => k.type === type && k.group === '清音').slice(0, 46).map((k, idx) => (
                        <div key={idx} className={`aspect-square flex flex-col items-center justify-center rounded-xl border-2 ${k.char ? 'bg-white border-indigo-50 hover:border-indigo-300 shadow-sm cursor-pointer' : 'border-transparent'} transition-all`}>
                            {k.char && <><span className="text-2xl md:text-3xl font-bold text-gray-800 font-sans">{k.char}</span><span className="text-xs md:text-sm text-gray-400 font-mono mt-1">{k.romaji}</span></>}
                        </div>
                    ))}
                </div>
            );
            return (
                <div className="max-w-4xl mx-auto p-4 animate-slideIn">
                    <div className="flex items-center mb-6"><Button variant="ghost" onClick={onBack}><LucideIcon name="ChevronLeft" /> 返回</Button><h2 className="text-2xl font-bold ml-2 text-gray-800">五十音練習</h2></div>
                    <div className="flex gap-4 mb-6 justify-center">
                        <button onClick={() => setActiveTab('hira')} className={`px-6 py-2 rounded-full font-bold transition-all ${activeTab === 'hira' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-gray-600'}`}>平假名</button>
                        <button onClick={() => setActiveTab('kata')} className={`px-6 py-2 rounded-full font-bold transition-all ${activeTab === 'kata' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-gray-600'}`}>片假名</button>
                    </div>
                    <div className="bg-white p-6 rounded-3xl shadow-xl border border-indigo-50">
                        {renderGrid(activeTab)}
                        <div className="mt-8"><h3 className="text-lg font-bold text-gray-700 mb-4 border-l-4 border-indigo-500 pl-3">濁音 / 半濁音</h3>
                            <div className="grid grid-cols-5 gap-2">{INITIAL_KANA.filter(k => (k.group === '濁音' || k.group === '半濁音') && k.type === (activeTab === 'hira' ? 'hira' : 'kata')).map((k, idx) => (<div key={idx} className="p-3 bg-gray-50 rounded-lg text-center border border-gray-100"><div className="text-xl font-bold font-sans">{k.char}</div><div className="text-xs text-gray-500">{k.romaji}</div></div>))}</div>
                        </div>
                        <div className="mt-8"><h3 className="text-lg font-bold text-gray-700 mb-4 border-l-4 border-indigo-500 pl-3">拗音 (部分)</h3>
                            <div className="grid grid-cols-5 gap-2">{INITIAL_KANA.filter(k => k.group === '拗音' && k.type === 'hira').map((k, idx) => (<div key={idx} className="p-3 bg-gray-50 rounded-lg text-center border border-gray-100"><div className="text-xl font-bold font-sans">{k.char}</div><div className="text-xs text-gray-500">{k.romaji}</div></div>))}</div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 測驗頁面 ---
        const QuizPage = ({ mode, onBack, vocabData }) => {
            const [gameState, setGameState] = useState('ready');
            const [questions, setQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [inputValue, setInputValue] = useState('');
            const [score, setScore] = useState(0);
            const [feedback, setFeedback] = useState(null); 
            const [history, setHistory] = useState([]); 
            const inputRef = useRef(null);
            const nextBtnRef = useRef(null);

            useEffect(() => { if(gameState === 'playing' && !feedback && inputRef.current) setTimeout(() => inputRef.current.focus(), 50); }, [gameState, currentIndex, feedback]);
            useEffect(() => { if(feedback && nextBtnRef.current) setTimeout(() => nextBtnRef.current.focus(), 50); }, [feedback]);
            useEffect(() => { if(gameState === 'ready') generateQuestions(); }, [gameState]);

            const generateQuestions = () => {
                let qList = [];
                const pool = vocabData.length > 0 ? vocabData : []; 
                
                if ((mode.includes('vocab') && pool.length === 0)) {
                    alert("單字庫是空的！請先到「單字練習」頁面匯入 CSV 單字。\n(若已匯入請稍待雲端同步)");
                    onBack();
                    return;
                }

                for(let i=0; i<20; i++) {
                    if(mode === 'vocab_spell') {
                        const item = pool[Math.floor(Math.random() * pool.length)];
                        qList.push({ q: item.word, a: item.romaji, displayA: item.romaji, meaning: item.meaning, hint: '請輸入羅馬拼音' });
                    }
                    else if(mode === 'vocab_reverse') {
                        const item = pool[Math.floor(Math.random() * pool.length)];
                        qList.push({ q: item.meaning, a: item.word, displayA: item.word, romaji: item.romaji, hint: '請輸入日文', meaning: item.meaning });
                    }
                    else if(mode === 'kana_single') {
                        const k = KANA_QUIZ_POOL[Math.floor(Math.random() * KANA_QUIZ_POOL.length)];
                        qList.push({ q: k.char, a: k.romaji, displayA: k.romaji, hint: '羅馬拼音' });
                    }
                    else if(mode === 'kana_combo') {
                       const k1 = KANA_QUIZ_POOL[Math.floor(Math.random() * KANA_QUIZ_POOL.length)];
                       const k2 = KANA_QUIZ_POOL[Math.floor(Math.random() * KANA_QUIZ_POOL.length)];
                       const k3 = KANA_QUIZ_POOL[Math.floor(Math.random() * KANA_QUIZ_POOL.length)];
                       qList.push({ q: `${k1.char}${k2.char}${k3.char}`, a: `${k1.romaji}${k2.romaji}${k3.romaji}`, displayA: `${k1.romaji}${k2.romaji}${k3.romaji}`, hint: '連續拼音' });
                    }
                }
                setQuestions(qList); setGameState('playing'); setCurrentIndex(0); setScore(0); setHistory([]); setInputValue(''); setFeedback(null);
            };

            const handleSubmit = () => {
                if (!inputValue.trim()) return;
                const currentQ = questions[currentIndex];
                const isCorrect = inputValue.trim().toLowerCase() === currentQ.a.toLowerCase();
                if (isCorrect) setScore(prev => prev + 5);
                setFeedback({
                    type: isCorrect ? 'correct' : 'wrong',
                    msg: isCorrect ? '回答正確！' : '回答錯誤',
                    correctAns: currentQ.displayA,
                    romaji: currentQ.romaji, 
                    detail: currentQ.meaning ? `字義: ${currentQ.meaning}` : '',
                    userA: inputValue
                });
            };

            const nextQuestion = () => {
                setHistory([...history, { ...questions[currentIndex], userAnswer: feedback.userA, isCorrect: feedback.type === 'correct' }]);
                setFeedback(null); setInputValue('');
                if (currentIndex < 19) setCurrentIndex(prev => prev + 1);
                else setGameState('finished');
            };

            if (gameState === 'finished') return (
                <div className="max-w-2xl mx-auto p-6 text-center animate-slideIn">
                    <h2 className="text-3xl font-bold mb-6 text-indigo-800">測驗結果</h2>
                    <div className="bg-white p-8 rounded-3xl shadow-xl mb-8">
                        <div className="text-6xl font-black text-indigo-600 mb-4">{score} <span className="text-2xl text-gray-400 font-medium">分</span></div>
                        <div className="h-96 overflow-y-auto border rounded-xl bg-gray-50 p-4 text-left">
                            <table className="w-full">
                                <thead><tr className="text-gray-400 text-sm border-b"><th className="pb-2 text-left">題目</th><th className="pb-2 text-center">您的回答</th><th className="pb-2 text-right">正確答案</th></tr></thead>
                                <tbody>{history.map((h,i) => (<tr key={i} className={`border-b last:border-0 ${h.isCorrect?'bg-green-50':'bg-red-50'}`}><td className="py-3 font-bold text-gray-800">{h.q}</td><td className={`py-3 text-center ${h.isCorrect?'text-green-600 font-bold':'text-red-500 line-through'}`}>{h.userAnswer}</td><td className="py-3 text-right text-indigo-600 font-bold">{h.displayA}</td></tr>))}</tbody>
                            </table>
                        </div>
                    </div>
                    <Button onClick={onBack} variant="secondary">返回</Button>
                </div>
            );

            if (gameState === 'playing' && questions.length > 0) {
                const q = questions[currentIndex];
                return (
                    <div className="max-w-xl mx-auto p-6 min-h-screen flex flex-col animate-slideIn">
                        <div className="flex items-center mb-4"><Button variant="ghost" onClick={onBack}><LucideIcon name="ChevronLeft" /> 退出</Button><div className="flex-1 text-center font-bold text-gray-400">問題 {currentIndex + 1} / 20</div></div>
                        <div className="bg-white rounded-3xl shadow-2xl p-10 text-center relative flex-1 flex flex-col justify-center">
                            <div className="text-5xl font-black text-gray-800 font-sans mb-4">{q.q}</div>
                            {mode === 'vocab_spell' && <div className="text-gray-500 mb-8">{q.meaning}</div>}
                            <input ref={inputRef} type="text" value={inputValue} onChange={e=>setInputValue(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleSubmit()} placeholder={q.hint} className="w-full text-center text-2xl p-4 border-b-4 border-indigo-100 focus:border-indigo-500 outline-none bg-transparent" autoComplete="off" />
                        </div>
                        {feedback && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-40 backdrop-blur-sm">
                                <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full text-center">
                                    <div className={`mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-4 ${feedback.type === 'correct' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>{feedback.type === 'correct' ? <LucideIcon name="CheckCircle" size={40} /> : <LucideIcon name="XCircle" size={40} />}</div>
                                    <h3 className="text-2xl font-bold mb-2">{feedback.msg}</h3>
                                    {feedback.type === 'wrong' && <div className="bg-red-50 p-4 rounded-xl mb-4"><div className="text-xs text-red-400 font-bold">正確答案</div><div className="text-2xl font-black text-gray-800">{feedback.correctAns}</div>{feedback.romaji && <div className="text-sm text-indigo-500 font-mono mt-1">{feedback.romaji}</div>}</div>}
                                    {feedback.detail && <p className="text-gray-500 mb-4">{feedback.detail}</p>}
                                    <Button ref={nextBtnRef} onClick={nextQuestion} className="w-full">下一題 (Enter)</Button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
            return <div>Loading...</div>;
        };

        // --- 單字庫頁面 (CSV 管理) ---
        const VocabLibraryPage = ({ onBack, vocabList, setVocabList, user }) => {
            const [isAdding, setIsAdding] = useState(false);
            const [newWord, setNewWord] = useState({ word: '', romaji: '', meaning: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [currentPage, setCurrentPage] = useState(1);
            const [importStatus, setImportStatus] = useState({ loading: false, progress: '' });
            const fileInputRef = useRef(null);
            
            const filtered = vocabList.filter(v => v.word.includes(searchTerm) || v.meaning.includes(searchTerm));
            const paginated = filtered.slice((currentPage-1)*50, currentPage*50);

            // CSV 匯出
            const handleExportCSV = () => {
                const header = "編號,日文單字,拼音,字義\n";
                const rows = vocabList.map((v, i) => `${i+1},${v.word},${v.romaji},${v.meaning}`).join('\n');
                const blob = new Blob(["\uFEFF"+header + rows], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `日文單字庫_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            };

            // CSV 匯入
            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                setImportStatus({ loading: true, progress: '讀取檔案中...' });
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const text = event.target.result;
                    const lines = text.split('\n');
                    
                    let newItems = [];
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line || line.startsWith('編號')) continue; 
                        
                        const parts = line.split(',');
                        if (parts.length >= 3) {
                            let word, romaji, meaning;
                            if (parts.length === 4) { [, word, romaji, meaning] = parts; }
                            else { [word, romaji, meaning] = parts; }
                            
                            if (word && romaji) {
                                newItems.push({
                                    word: word.trim(),
                                    romaji: romaji.trim(),
                                    meaning: (meaning || '').trim(),
                                    id: Date.now() + Math.random() + i // 暫時ID (離線用)
                                });
                            }
                        }
                    }

                    // 如果有連線 Firebase，上傳資料 (強制等待完成)
                    if (user && window.firebase) {
                        try {
                            const db = firebase.firestore();
                            const batchLimit = 400; 
                            let batch = db.batch();
                            let batchCount = 0;
                            let totalUploaded = 0;
                            
                            for (let i = 0; i < newItems.length; i++) {
                                const item = newItems[i];
                                const newDocRef = db.collection('user_vocab').doc();
                                batch.set(newDocRef, {
                                    word: item.word,
                                    romaji: item.romaji,
                                    meaning: item.meaning,
                                    userId: user.uid,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                batchCount++;
                                
                                if (batchCount >= batchLimit) {
                                    setImportStatus({ loading: true, progress: `正在同步到雲端... (${totalUploaded}/${newItems.length})` });
                                    await batch.commit();
                                    totalUploaded += batchCount;
                                    batch = db.batch();
                                    batchCount = 0;
                                }
                            }
                            if (batchCount > 0) {
                                setImportStatus({ loading: true, progress: `正在同步到雲端... (${totalUploaded}/${newItems.length})` });
                                await batch.commit();
                            }
                            
                            alert(`成功匯入 ${newItems.length} 筆單字到雲端！\n列表將自動更新。`);
                        } catch(e) {
                            console.error(e);
                            alert("匯入雲端失敗，請檢查網路。錯誤: " + e.message);
                            // 失敗時才手動更新本地列表作為備案
                            setVocabList(prev => [...newItems, ...prev]);
                        }
                    } else {
                        // 離線模式手動更新
                        setVocabList(prev => [...newItems, ...prev]);
                        alert(`已匯入 ${newItems.length} 筆單字 (離線模式)`);
                    }
                    
                    setImportStatus({ loading: false, progress: '' });
                    e.target.value = null; 
                };
                reader.readAsText(file);
            };

            const handleAdd = async () => {
                if(!newWord.word) return;
                const tempItem = { ...newWord, id: Date.now(), userId: user?.uid };
                
                // 如果是離線，手動更新 UI；如果是連線，等待 Snapshot 更新
                if(!user) {
                    setVocabList(prev => [tempItem, ...prev]);
                }

                if(user && window.firebase) {
                    try {
                        await firebase.firestore().collection('user_vocab').add({
                            ...newWord, userId: user.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch(e) { console.error(e); }
                }
                setNewWord({ word: '', romaji: '', meaning: '' });
                setIsAdding(false);
            };

            const handleDelete = async (id) => {
                if(!confirm('確定刪除此單字？')) return;
                
                if(user && window.firebase) {
                    try {
                        await firebase.firestore().collection('user_vocab').doc(id).delete();
                        // 雲端模式不需手動 setVocabList，onSnapshot 會處理
                    } catch(e) { console.log('Delete failed', e); }
                } else {
                    setVocabList(prev => prev.filter(v => v.id !== id)); 
                }
            };

            return (
                <div className="max-w-5xl mx-auto p-4 animate-slideIn">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div className="flex items-center"><Button variant="ghost" onClick={onBack}><LucideIcon name="ChevronLeft" /> 返回</Button><h2 className="text-2xl font-bold ml-2 text-gray-800">單字練習</h2></div>
                        <div className="flex items-center gap-2"><LucideIcon name="Search" size={18}/><input className="border rounded-full px-4 py-2 w-full md:w-64" placeholder="搜尋..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} /></div>
                    </div>
                    
                    <div className="mb-4 p-4 bg-blue-50 rounded-xl flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-2 text-blue-800 text-sm">
                            <LucideIcon name="Cloud" size={16}/> {user ? '雲端同步中' : '離線模式'} 
                            <span className="font-bold ml-2">單字庫: {vocabList.length} 字</span>
                        </div>
                        <div className="flex gap-2 flex-wrap justify-center">
                            <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".csv" className="hidden" />
                            <Button onClick={() => fileInputRef.current.click()} variant="secondary" className="text-xs py-2 bg-blue-600 text-white border-none hover:bg-blue-700" disabled={importStatus.loading}>
                                {importStatus.loading ? <><LucideIcon name="RotateCcw" className="animate-spin mr-1" size={14}/> {importStatus.progress}</> : <><LucideIcon name="Upload" size={14}/> 匯入 CSV</>}
                            </Button>
                            <Button onClick={handleExportCSV} variant="secondary" className="text-xs py-2"><LucideIcon name="Download" size={14}/> 匯出 CSV</Button>
                            <Button onClick={()=>setIsAdding(true)} variant="primary" className="text-xs py-2"><LucideIcon name="Plus" size={14}/> 新增</Button>
                        </div>
                    </div>

                    {isAdding && (
                        <div className="bg-white p-4 rounded-xl shadow-lg mb-4">
                            <h3 className="font-bold mb-3 text-gray-700">新增單字</h3>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-2">
                                <input className="border p-2 rounded" placeholder="日文 (例: 私)" value={newWord.word} onChange={e=>setNewWord({...newWord, word:e.target.value})} />
                                <input className="border p-2 rounded" placeholder="拼音 (例: watashi)" value={newWord.romaji} onChange={e=>setNewWord({...newWord, romaji:e.target.value})} />
                                <input className="border p-2 rounded" placeholder="意思 (例: 我)" value={newWord.meaning} onChange={e=>setNewWord({...newWord, meaning:e.target.value})} />
                                <div className="flex gap-2">
                                    <Button onClick={handleAdd} className="flex-1">儲存</Button>
                                    <Button onClick={() => setIsAdding(false)} variant="light" className="flex-1">取消</Button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div className="grid grid-cols-12 bg-gray-50 p-3 text-sm font-bold text-gray-500"><div className="col-span-1">#</div><div className="col-span-3">日文</div><div className="col-span-3">拼音</div><div className="col-span-4">意思</div><div className="col-span-1"></div></div>
                        <div className="divide-y">
                            {paginated.map((v, i) => (
                                <div key={v.id} className="grid grid-cols-12 p-3 hover:bg-gray-50 items-center text-sm">
                                    <div className="col-span-1 text-gray-400">{i+1 + (currentPage-1)*50}</div>
                                    <div className="col-span-3 font-bold font-sans text-gray-800">{v.word}</div>
                                    <div className="col-span-3 font-mono text-gray-500">{v.romaji}</div>
                                    <div className="col-span-4 text-gray-600">{v.meaning}</div>
                                    <div className="col-span-1 text-right"><button onClick={()=>handleDelete(v.id)} className="text-gray-300 hover:text-red-500"><LucideIcon name="Trash2" size={16}/></button></div>
                                </div>
                            ))}
                            {paginated.length===0 && <div className="p-8 text-center text-gray-400">目前無單字。<br/>請點擊上方按鈕匯入 CSV 檔案。</div>}
                        </div>
                    </div>
                    
                    <div className="flex justify-center mt-4 gap-4">
                        <button disabled={currentPage===1} onClick={()=>setCurrentPage(p=>p-1)} className="p-2 bg-white rounded-full shadow disabled:opacity-50"><LucideIcon name="ChevronLeft" /></button>
                        <span className="py-2">第 {currentPage} 頁</span>
                        <button disabled={paginated.length<50} onClick={()=>setCurrentPage(p=>p+1)} className="p-2 bg-white rounded-full shadow disabled:opacity-50"><LucideIcon name="ChevronRight" /></button>
                    </div>
                </div>
            );
        };

        // --- 主程式 ---
        function App() {
            const [view, setView] = useState('home');
            const [user, setUser] = useState(null);
            const [vocabList, setVocabList] = useState([]);
            const [dbStatus, setDbStatus] = useState('init'); // init, connecting, connected, offline

            // 監聽 Firebase 登入狀態
            useEffect(() => {
                if (window.firebase) {
                    setDbStatus('connecting');
                    const unsubscribe = window.firebase.auth().onAuthStateChanged(u => {
                        setUser(u);
                        if(u) setDbStatus('connected');
                        else setDbStatus('offline'); // 可能是未登入或初始化失敗
                    });
                    
                    window.firebase.auth().signInAnonymously()
                        .then(() => console.log("Signed in anonymously"))
                        .catch(err => {
                            console.error("Auth failed", err);
                            setDbStatus('offline');
                        });
                        
                    return () => unsubscribe();
                } else {
                    setDbStatus('offline');
                }
            }, []);

            // 監聽雲端資料 - 修正: 移除 orderBy 以避免需要 Index
            useEffect(() => {
                if (user && window.firebase) {
                    const db = window.firebase.firestore();
                    // 開啟持續監聽 (移除 orderBy('createdAt') 以避免 Index 報錯)
                    const unsubscribe = db.collection('user_vocab')
                        .where('userId', '==', user.uid)
                        .onSnapshot(snapshot => {
                            const list = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                            // 在前端進行排序
                            list.sort((a, b) => {
                                const ta = a.createdAt?.seconds || 0;
                                const tb = b.createdAt?.seconds || 0;
                                return ta - tb;
                            });
                            setVocabList(list);
                        }, error => {
                            console.error("Snapshot error:", error);
                        });
                    return () => unsubscribe();
                }
            }, [user]);

            if (view === 'home') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-br from-orange-50 to-indigo-50">
                    <h1 className="text-4xl font-black text-indigo-900 mb-2">日本語学習</h1>
                    <p className="text-gray-500 mb-6">累積單字，積沙成塔</p>
                    
                    {/* 資料庫連線狀態顯示 */}
                    <div className="mb-10 flex items-center gap-2 px-4 py-2 bg-white rounded-full shadow-sm text-sm border border-gray-100">
                        {dbStatus === 'connecting' && <><LucideIcon name="Loader2" className="animate-spin text-yellow-500" size={16}/> <span className="text-gray-600">連線資料庫中...</span></>}
                        {dbStatus === 'connected' && <><div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div> <span className="text-gray-600">資料庫已連線 (ID: {user?.uid.slice(0,5)}...)</span></>}
                        {dbStatus === 'offline' && <><LucideIcon name="WifiOff" className="text-gray-400" size={16}/> <span className="text-gray-400">離線模式 (資料僅暫存)</span></>}
                    </div>

                    <div className="grid md:grid-cols-2 gap-6 w-full max-w-2xl">
                        <div onClick={()=>setView('kana_menu')} className="bg-white p-8 rounded-3xl shadow-lg hover:-translate-y-1 transition cursor-pointer border-2 border-transparent hover:border-pink-300 group">
                            <span className="text-4xl text-pink-500 font-bold block mb-4 group-hover:scale-110 transition-transform origin-left">あ</span>
                            <h2 className="text-xl font-bold">五十音練習</h2>
                        </div>
                        <div onClick={()=>setView('vocab_menu')} className="bg-white p-8 rounded-3xl shadow-lg hover:-translate-y-1 transition cursor-pointer border-2 border-transparent hover:border-indigo-300 group">
                            <LucideIcon name="Book" className="w-10 h-10 text-indigo-500 mb-4 group-hover:scale-110 transition-transform origin-left" />
                            <h2 className="text-xl font-bold">單字練習</h2>
                            <p className="text-sm text-gray-400 mt-2">目前單字數: {vocabList.length}</p>
                        </div>
                    </div>
                </div>
            );

            if (view === 'kana_menu') return (
                <div className="min-h-screen p-6 max-w-md mx-auto flex flex-col justify-center gap-4">
                    <Button variant="ghost" onClick={()=>setView('home')} className="self-start"><LucideIcon name="ChevronLeft"/> 首頁</Button>
                    <h2 className="text-3xl font-bold text-center mb-4">五十音練習</h2>
                    <Button onClick={()=>setView('kana_table')} variant="secondary">五十音表</Button>
                    <Button onClick={()=>setView('quiz_kana_single')}>拼音練習 (單字)</Button>
                    <Button onClick={()=>setView('quiz_kana_combo')}>連續拼音 (組合)</Button>
                    <Button onClick={()=>setView('quiz_vocab_spell')}>日文單字拼音</Button>
                </div>
            );

            if (view === 'vocab_menu') return (
                <div className="min-h-screen p-6 max-w-md mx-auto flex flex-col justify-center gap-4">
                    <Button variant="ghost" onClick={()=>setView('home')} className="self-start"><LucideIcon name="ChevronLeft"/> 首頁</Button>
                    <h2 className="text-3xl font-bold text-center mb-4">單字練習</h2>
                    <Button onClick={()=>setView('vocab_lib')} variant="secondary">管理單字庫 ({vocabList.length})</Button>
                    <Button onClick={()=>setView('quiz_vocab_reverse')}>中翻日練習 (填日文)</Button>
                </div>
            );

            if (view === 'kana_table') return <KanaTablePage onBack={()=>setView('kana_menu')} />;
            if (view === 'vocab_lib') return <VocabLibraryPage onBack={()=>setView('vocab_menu')} vocabList={vocabList} setVocabList={setVocabList} user={user} />;
            
            // 路由處理
            const isQuiz = view.startsWith('quiz_');
            if (isQuiz) {
                const mode = view.replace('quiz_', '');
                return <QuizPage mode={mode} onBack={()=>setView(mode.includes('vocab') ? 'vocab_menu' : 'kana_menu')} vocabData={vocabList} />;
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
